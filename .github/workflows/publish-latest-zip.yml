name: Publish latest plugin ZIP (SFTP)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    environment: TCBF

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build latest.zip
        run: |
          set -e
          PLUGIN_SLUG="tc-booking-flow"
          BUILD_DIR="build"

          echo "Building plugin zip..."
          mkdir -p "$BUILD_DIR/$PLUGIN_SLUG"

          echo "Copying files to build directory..."
          rsync -av \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "$BUILD_DIR" \
            --exclude ".DS_Store" \
            ./ "$BUILD_DIR/$PLUGIN_SLUG/"

          echo "Contents of build directory:"
          ls -la "$BUILD_DIR/$PLUGIN_SLUG/"

          echo "Verifying main plugin file was copied:"
          ls -lh "$BUILD_DIR/$PLUGIN_SLUG/tc-booking-flow.php"
          head -5 "$BUILD_DIR/$PLUGIN_SLUG/tc-booking-flow.php"

          echo "File count in build directory:"
          find "$BUILD_DIR/$PLUGIN_SLUG" -type f | wc -l

          cd "$BUILD_DIR"
          zip -r "../latest.zip" "$PLUGIN_SLUG"

          echo "Zip file created:"
          ls -lh ../latest.zip

          echo "Zip contents (first 30 entries):"
          unzip -l ../latest.zip | head -30

          echo "Verifying zip integrity:"
          unzip -t ../latest.zip

          echo "Checking main plugin file in zip:"
          unzip -p ../latest.zip "$PLUGIN_SLUG/tc-booking-flow.php" | head -10

      - name: Create latest.json
        run: |
          set -e

          # Extract version from main plugin file
          VERSION=$(grep -oP "Version:\s*\K[\d\.]+" tc-booking-flow.php)
          COMMIT="$(git rev-parse --short HEAD)"
          DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          DOWNLOAD_URL="https://staging.lukaszkomar.com/dev/tc-booking-flow/latest.zip"

          echo "Creating latest.json with version $VERSION"

          # Create JSON with WordPress plugin update checker format
          cat > latest.json <<'EOF'
{
  "name": "TC — Booking Flow (GF → Cart → Order) + Early Booking Snapshot",
  "version": "VERSION_PLACEHOLDER",
  "download_url": "DOWNLOAD_URL_PLACEHOLDER",
  "requires": "5.0",
  "tested": "6.4",
  "last_updated": "DATE_PLACEHOLDER",
  "sections": {
    "description": "Consolidates GF44 → Woo cart/order booking flow and Early Booking Discount snapshot. Supports optional split of participation vs rental and per-event EB scope toggles.",
    "changelog": "<h4>VERSION_PLACEHOLDER</h4><ul><li>Build commit: COMMIT_PLACEHOLDER</li><li>Build date: DATE_PLACEHOLDER</li></ul>"
  }
}
EOF

          # Replace placeholders
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" latest.json
          sed -i "s|DOWNLOAD_URL_PLACEHOLDER|$DOWNLOAD_URL|g" latest.json
          sed -i "s/DATE_PLACEHOLDER/$DATE/g" latest.json
          sed -i "s/COMMIT_PLACEHOLDER/$COMMIT/g" latest.json

          echo "Generated latest.json:"
          cat latest.json

      - name: Install SFTP tools
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Probe SFTP root (no shell)
        env:
          SFTP_HOST_RAW: ${{ secrets.FTP_SERVER }}
          SFTP_USER_RAW: ${{ secrets.FTP_USERNAME }}
          SFTP_PASS: ${{ secrets.FTP_PASSWORD }}
        run: |
          set -e

          SFTP_HOST="$(printf "%s" "$SFTP_HOST_RAW" | tr -d '\r' | xargs)"
          SFTP_USER="$(printf "%s" "$SFTP_USER_RAW" | tr -d '\r' | xargs)"

          cat > sftp-probe.txt <<'EOF'
          pwd
          ls
          bye
          EOF

          sshpass -p "$SFTP_PASS" sftp \
            -oBatchMode=no \
            -oStrictHostKeyChecking=no \
            -oUserKnownHostsFile=/dev/null \
            -P 22 \
            -b sftp-probe.txt \
            "$SFTP_USER@$SFTP_HOST"

      - name: Upload via SFTP (no shell)
        env:
          SFTP_HOST_RAW: ${{ secrets.FTP_SERVER }}
          SFTP_USER_RAW: ${{ secrets.FTP_USERNAME }}
          SFTP_PASS: ${{ secrets.FTP_PASSWORD }}
          REMOTE_DIR_RAW: ${{ secrets.FTP_REMOTE_DIR }}
        run: |
          set -e

          SFTP_HOST="$(printf "%s" "$SFTP_HOST_RAW" | tr -d '\r' | xargs)"
          SFTP_USER="$(printf "%s" "$SFTP_USER_RAW" | tr -d '\r' | xargs)"
          REMOTE_DIR="$(printf "%s" "$REMOTE_DIR_RAW" | tr -d '\r' | xargs)"

          cat > sftp-batch.txt <<EOF
          EOF

          # Only navigate if REMOTE_DIR is set and not current directory
          if [ -n "$REMOTE_DIR" ] && [ "$REMOTE_DIR" != "." ]; then
            # Create directories recursively by navigating step-by-step
            IFS='/' read -ra DIRS <<< "$REMOTE_DIR"

            # Build mkdir and cd commands for each directory level
            for DIR in "${DIRS[@]}"; do
              if [ -n "$DIR" ]; then
                cat >> sftp-batch.txt <<EOF
          -mkdir "$DIR"
          cd "$DIR"
          EOF
              fi
            done
          fi

          cat >> sftp-batch.txt <<EOF
          put latest.zip
          put latest.json
          pwd
          ls -la
          bye
          EOF

          sshpass -p "$SFTP_PASS" sftp \
            -oBatchMode=no \
            -oStrictHostKeyChecking=no \
            -oUserKnownHostsFile=/dev/null \
            -P 22 \
            -b sftp-batch.txt \
            "$SFTP_USER@$SFTP_HOST"
